{% extends 'layout/manage.html' %}
{% load project %}

{% block title %}目标检测{% endblock %}
{% block css %}
    <style>
        #result {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            display: none;
        }

        #file-detail-panel, #training-panel {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        #training-panel {
            display: none; /* 初始隐藏 */
        }
    </style>
{% endblock %}

{% block content %}
    {% file_in_task request %}
    <h2>目标检测系统</h2>

    <!-- 激活面板的按钮 -->
    <button id="toggle-panel" class="btn btn-primary">试试效果!</button>
    <button id="start-training" class="btn btn-secondary">开始训练</button>

    <!-- 目标检测面板 -->
    <div id="file-detail-panel">
        <h3>目标检测</h3>
        <form id="detection-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="file-select">选择文件:</label>
                <select id="file-select" class="form-control" required>
                    <option value="">请选择一个文件</option>
                    {% for file in files %}
                        <option value="{{ file.id }}">{{ file.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="threshold">置信度阈值:</label>
                <input type="number" id="threshold" class="form-control" value="0.5" step="0.01" min="0" max="1"
                       required>
            </div>
            <button type="submit" class="btn btn-success">开始检测</button>
        </form>

        <div id="result">
            <h3>检测结果</h3>
            <ul id="result-list"></ul>
        </div>
    </div>

    <!-- 开始训练面板 -->
    <div id="training-panel">
        <h3>训练模块</h3>
        <p>此处可以添加训练相关的内容或功能。</p>
        <button id="start-training-submit" class="btn btn-success">开始训练</button>
    </div>

{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            // 切换面板显示
            $('#toggle-panel').on('click', function () {
                $('#file-detail-panel').toggle(); // 显示或隐藏目标检测面板
                $('#training-panel').hide(); // 确保训练面板隐藏
            });

            // 切换到训练面板
            $('#start-training').on('click', function () {
                $('#file-detail-panel').hide(); // 隐藏目标检测面板
                $('#training-panel').show(); // 显示训练面板
            });

            // AJAX 设置 CSRF token
            $.ajaxSetup({
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                }
            });

            // 处理目标检测表单提交
            $('#detection-form').on('submit', function (e) {
                e.preventDefault(); // 阻止表单提交

                // 获取选择的文件 ID 和阈值
                var selectedFileId = $('#file-select').val();  // 从下拉菜单获取文件 ID
                var threshold = $('#threshold').val();          // 获取阈值

                // 发送 AJAX 请求
                $.ajax({
                    url: '{% url "manage:detectry" project_id=request.tracer.project.id %}',  // 替换为您的后端处理URL
                    type: 'POST',
                    data: {
                        'file_id': selectedFileId, // 选择的文件 ID
                        'threshold': threshold       // 置信度阈值
                    },
                    success: function (data) {
                        $('#result-list').empty(); // 清空之前的结果
                        if (data.status) {
                            data.detections.forEach(function (detection) {
                                $('#result-list').append('<li>' + detection + '</li>');
                            });
                        } else {
                            $('#result-list').append('<li>' + data.message + '</li>');
                        }
                        $('#result').show(); // 显示结果面板
                    },
                    error: function (xhr) {
                        alert('请求失败: ' + xhr.statusText);
                    }
                });
            });

            // 处理开始训练的点击事件
            $('#start-training-submit').on('click', function () {
                // 这里可以添加 AJAX 请求或其他逻辑来开始训练
                alert('开始训练的逻辑尚未实现。');
            });
        });

        function closePanel() {
            $('#file-detail-panel').hide();  // 隐藏面板
        }
    </script>
{% endblock %}